@model ClinicaMVC.Models.Paciente

@{
}

<h2>@ViewBag.Title</h2>
<h3>Inserir Novo</h3>

<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
@*This is for jquery*@
<script src="../../Scripts/jquery-1.7.1.js" type="text/javascript"></script>
@*This is for jquery UI, for Calender control*@
<script src="../../Scripts/jquery-ui-1.8.18.js" type="text/javascript"></script>
@*This is for JSON*@
<script src="../../Scripts/json2.js" type="text/javascript"></script>

@*These are for DataTables*@

<script src="../../Scripts/DataTables-1.9.0/media/js/jquery.dataTables.js" type="text/javascript"></script>
<script src="../../Scripts/DataTables-1.9.0/extras/TableTools/media/js/TableTools.js" type="text/javascript"></script>
<script src="../../Scripts/DataTables-1.9.0/extras/TableTools/media/js/ZeroClipboard.js" type="text/javascript"></script>

@*These are for styling Control*@
<link href="../../Content/DataTables-1.9.0/extras/TableTools/media/css/TableTools.css"
    rel="stylesheet" type="text/css" />
<link href="../../Content/DataTables-1.9.0/extras/TableTools/media/css/TableTools_JUI.css"
    rel="stylesheet" type="text/css" />
<link href="../../Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">

    //This function is used for sending data(JSON Data) to SalesController
    function Sales_save() {
        // 1º: Lê os dados da grade e criar um JSON

        // Criando um Telefone JSON Object
        var Telefone = {
            "TelefoneId": "",
            "Numero": "",
            "Tipo": ""
        };

        var PacienteTelefone = {
            "PacienteTelefoneId": "",
            "PacienteId": "",
            "TelefoneId": "",
            "Telefone" :[]
        }
        // Criando um Paciente Json Object
        var Paciente = { "PacienteId": "", "Nome": "", "Endereco": "", "ObservacaoMedico": "", "PacienteTelefone": [] };

        // Set Sales Main Value
        Paciente.PacienteId = $("#PacienteId").val();
        Paciente.ReferenceNo = $("#Nome").val();
        Paciente.SalesDate = $("#ObservacaoMedico").val();

        // Getting Table Data from where we will fetch Sales Sub Record
        var oTable = $('.tbl').dataTable().fnGetData();

        for (var i = 0; i < oTable.length; i++) {

            // IF This view is for edit then it will read SalesId from Hidden field
            if ($('h2').text() == "Edit") {
                /*salessub.SalesId = $('#SalesId').val();*/
            }
            else {
                Telefone.TelefoneId = 0;
            }

            PacienteTelefone.PacienteTelefoneId = 0;
            PacienteTelefone.TelefoneId = 0;
            PacienteTelefone.PacienteId = Paciente.PacienteId;

            // Set SalesSub individual Value
            Telefone.Numero = oTable[i][0];
            Telefone.Tipo = oTable[i][1];
            PacienteTelefone.Telefone.push(Telefone);

            // adding to SalesMain.SalesSub List Item
            Paciente.PacienteTelefone.push(PacienteTelefone);
            var Telefone = {
                "TelefoneId": "",
                "Numero": "",
                "Tipo": ""
            };


        }
        // Step 1: Ends Here


        // Set 2: Ajax Post
        // Here i have used ajax post for saving/updating information
        $.ajax({
            url: '/Paciente/Create',
            data: JSON.stringify(Paciente),
            type: 'POST',
            contentType: 'application/json;',
            dataType: 'json',
            success: function (result) {

                if (result.Success == "1") {
                    window.location.href = "/Paciente/index";
                }
                else {
                    alert(result.ex);
                }
            }
        });


    }


    $(document).ready(function () {

        // here i have used datatables.js (jQuery Data Table)
        $('.tbl').dataTable({
            "sDom": 'T<"clear">lfrtip',
            "oTableTools": {
                "aButtons": [],
                "sRowSelect": "single"
            },
            "bLengthChange": false,
            "bFilter": false,
            "bSort": false,
            "bInfo": false
        });

        var oTable = $('.tbl').dataTable();
    });

    // Esta função serve para adicionar á um item na tabela
    function Add() {

        $('.tbl').dataTable().fnAddData([$('#Numero').val(), $('#Tipo').val()]);

        //Esvaziando os componentes.
        $('#Numero').val("");
        $('#Tipo').val("");

    }


    function DeleteRow() {
            
        var oTT = TableTools.fnGetInstance('tbl'); // Get Table instance
        var sRow = oTT.fnGetSelected(); // Get Selected Item From Table

        $('.tbl').dataTable().fnDeleteRow(sRow[0]);

    }


</script>



@using (Html.BeginForm())
{
    @Html.ValidationSummary(true)
    <fieldset>        

        <div class="editor-label">
            @Html.LabelFor(model => model.Nome)
        </div>
        <div class="editor-field">
            @Html.EditorFor(model => model.Nome)
            @Html.ValidationMessageFor(model => model.Nome)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.Endereco)
        </div>
        <div class="editor-field">
            @Html.EditorFor(model => model.Endereco)
            @Html.ValidationMessageFor(model => model.Endereco)
        </div>

        <div class="editor-label">
            @Html.LabelFor(model => model.ObservacaoMedico)
        </div>
        <div class="editor-field">
            @Html.EditorFor(model => model.ObservacaoMedico)
            @Html.ValidationMessageFor(model => model.ObservacaoMedico)
        </div>
        <p>
            <input type="submit" value="Salvar" />
        </p>
    </fieldset>
    
        <fieldset>
        <legend>Telefones</legend>
        <label>Numero :</label>
        @Html.TextBox("Numero")
        <label>Tipo:</label>
        @Html.TextBox("Tipo")

        <input type="button" value= "Add" onclick="Add()" />
        <br />
        <br />

       <table class="tbl" id="tbl">
       <thead>
       <tr>
       <th>Número</th> <th>Tipo</th>
       </tr>
       </thead>
       
       <tbody>
       @if (Model != null)
       {
           foreach (var item in Model.PacienteTelefone)
           { 
           <tr>
               <td>
               @Html.DisplayTextFor(i => item.Telefone.Numero)
               </td>           
               <td>
               @Html.DisplayTextFor(i => item.Telefone.Tipo)
               </td>           
           </tr>
           }
       }
       
       </tbody>
       
       </table>
       <br />
       <input type="button" value="Delete Selected Row" onclick="DeleteRow()" />
       </fieldset>    
     <input type="button" value="Sales Save" onclick="Sales_save()" />
}

<div>
    @Html.ActionLink("Voltar", "Index")
</div>

